<?php

/**
 * SpeedSize Image & Video AI-Optimizer - Worpress plugin
 *
 * @category Image Optimization / CDN / Page Speed & Performance
 * @package  speedsize
 * @author   SpeedSize (https://speedsize.com/)
 * @author   Developed by Pniel (Pini) Cohen | Trus (https://www.trus.co.il/)
 */

if (! defined('ABSPATH')) {
    exit; // Exit if accessed directly.
}

?>

<!-- SpeedSize JS Snippet -->
<script id="speedsize-js-snippet" data-speedsize-plugin="<?= esc_attr_e(SPEEDSIZE_VERSION) ?>" defer>
/* SpeedSize-script - 19-08-2024 */
(function () {
var speedsizeClient = {
    clientId: '<?= esc_js(SpeedSize_Config::get_speedsize_client_id()) ?>',
    mLinkBaseUrl: '<?= esc_js(SpeedSize_Config::get_speedsize_service_base_url()) ?>',
    forbiddenPaths: JSON.parse('<?= \json_encode(SpeedSize_Config::get_speedsize_client_forbidden_paths(true)) ?>'),
    whitelistDomains: JSON.parse('<?= \json_encode(SpeedSize_Config::get_all_allowed_domains()) ?>')
};
var config = {"clientId":speedsizeClient.clientId,"isAllowed":true,"disableAllParams":true,"innerHtmlHook":true,"mLinkBaseUrl":speedsizeClient.mLinkBaseUrl,"format":"auto","allowedPaths":[],"MODisabled":true,"maxDpr":1.5,"ignoreDataAttributes":false,"enableStatement":"","disableWorker":true,"forbiddenPaths":speedsizeClient.forbiddenPaths,"searchChildren":false,"whitelistDomains":speedsizeClient.whitelistDomains,"useOriginalCDN":false,"disableBackgroundAutoResize":true,"processPreloadImages":false,"lazyload":{"native":true},"allowCrossOrigin":false,"disablePrototypeHooks":false} || {};
var e=window.location.origin+window.location.pathname;if(!("/"===e.charAt(e.length-1)||e.endsWith(".html")||e.endsWith(".htm")||e.endsWith(".php")||e.endsWith(".asp")||e.endsWith(".aspx")||e.endsWith(".jsp")))e+="/";var t=(window.location.search||"").substring(1);// without '?'
var r=t.split("&");var i=[];for(var n=0;n<r.length;n+=1){var a=r[n];if("nospeedsize"===a||a===config.enableStatement)continue;i.push(a)}var s=i.join("&");var o=s?window.location.pathname+"?"+s:window.location.pathname;o=o.toLowerCase();function f(t){var r=new URL(t,e);var i=r.href;if(r.hash)i=r.origin+r.pathname+r.search;return{srcUrl:i.replace(/%7B/g,"{").replace(/%7D/g,"}"),hash:r.hash||"",hostname:r.hostname,pathname:r.pathname}}var c=new URL(config.mLinkBaseUrl).hostname;function d(t){var r=!1;var{hostname:i}=new URL(t,e);if(i===c)return!1;if(config.whitelistDomains&&config.whitelistDomains.length)for(var n=0;n<config.whitelistDomains.length;n+=1){var a=config.whitelistDomains[n];if(i.indexOf(a)>=0){r=!0;break}}return r}function l(e){if(0===e.indexOf("data:image"))return e;if(e.indexOf("speedsize-ignore")>=0)return e;var{srcUrl:t,hash:r,pathname:i}=f(e);if("/"===i)return e;if(!config.allowCrossOrigin&&u(t)&&!d(t))return e;return config.mLinkBaseUrl+"/"+config.clientId+"/"+t+r}function u(t){if(!t||0===t.indexOf("data:image"))return!1;var r=new URL(t,e).hostname;if(r===c)return!0;if(r.endsWith(window.location.hostname))return!1;if(0!==t.indexOf(window.location.origin))return!0;return!1}function g(e){if(e.dataset["speedsize-ignore"]||e.dataset.speedsizeIgnore||e.hasAttribute("data-speedsize-ignore")||e.speedsize)return;if(e.hasAttribute("data-src")){var t=l(e.getAttribute("data-src"));e.setAttribute("data-src",t)}if(e.hasAttribute("data-srcset")){var r=h(e.dataset.srcset);e.setAttribute("data-srcset",r)}e.speedsize=!0;if(!config.allowCrossOrigin&&u(e.src)&&!d(e.src))return;if(e.complete||!e.hasAttribute("src")&&!e.hasAttribute("srcset")||0===e.src.indexOf("data:image"))return;if(e.hasAttribute("src")){var i=l(e.getAttribute("src"));e.setAttribute("src",i)}if(e.srcset){var n=h(e.srcset);e.setAttribute("srcset",n)}}function p(e){var t=[];var r="url(";var i=e;for(;i.indexOf(r)>=0;){var n=i.indexOf(r);if(-1===n)return null;var a=n+r.length;var s=i.indexOf(")",a);var o=i.substring(a,s);if('"'===o.charAt(0)&&i.indexOf('")',a)>=0)s=i.indexOf('")',a)+1;else if("'"===o.charAt(0)&&i.indexOf("')",a)>=0)s=i.indexOf("')",a)+1;var f=i.substring(a,s);if('"'===f.charAt(0)||"'"===f.charAt(0))f=f.substring(1,f.length-1);if(0!==f.indexOf("data:"))t.push(f);i=i.substring(s+1);if(-1===s)break}return t}function h(e){if(!e)return"";if(e.indexOf(config.mLinkBaseUrl)>=0)return e;var t=e.split(",");for(var r=0;r<t.length;r+=1){var i=t[r].trim().split(" ")[0];var n=f(i).srcUrl;if(!config.allowCrossOrigin&&u(n)&&!d(n))continue;var a=l(i);t[r]=t[r].replace(i,a)}return t.join(",")}function v(e,t,r){if(String.prototype.replaceAll)return e.replaceAll(t,r);var i=new RegExp(t,"g");return e.replace(i,r)}function b(e){if(e.hasAttribute("data-processed"))return;var t=e.style.backgroundImage;var r=!1;if(!t&&e.hasAttribute("style")){r=!0;t=e.getAttribute("style")}if(!t)return;var i=p(t);i=Array.from(new Set(i));var n=t;for(var a=0;a<i.length;a+=1){var s=i[a];n=v(n,s,l(f(s).srcUrl))}if(i.length)if(r)e.setAttribute("style",n);else e.style.backgroundImage=n;e.setAttribute("data-processed",!0)}function m(e){if(e.hasAttribute("src"))return e.getAttribute("src");var t=e.querySelectorAll("source");if(!t||!t.length)return"";var r=t[t.length-1].src;var i;var n;var a;for(var s=0;s<t.length;s+=1){var o=t[s];if(o.hasAttribute("type")&&"video/mp4"===o.getAttribute("type"))n=o.src;if(o.src.endsWith(".mp4"))a=o.src;if(o.hasAttribute("media")&&window.matchMedia(o.getAttribute("media")).matches)i=o.src}return n||a||i||r}function O(e){var t=e.querySelectorAll("source");for(var r=0;r<t.length;r+=1){var i=t[r];var n=i.getAttribute("data-src");if(n&&!n.speedsize){var a=l(n);i.setAttribute("data-src",a)}}}function y(e){if(e.speedsize)return;if(e.dataset["speedsize-ignore"]||e.dataset.speedsizeIgnore||e.hasAttribute("data-speedsize-ignore"))return;if(e.hasAttribute("autoplay")&&e.hasAttribute("poster"))e.removeAttribute("poster");var t=m(e);O(e);if(!t)return;e.speedsize=!0;if(!config.allowCrossOrigin&&u(t)&&!d(t))return;if(e.hasAttribute("autoplay")){if(!e.hasAttribute("muted"))e.setAttribute("muted",!0);if(!e.hasAttribute("playsinline"))e.setAttribute("playsinline",!0)}e.src=l(t)}function A(e,t,r,i){return e.substring(0,t)+i+e.substring(r)}var{setAttribute:w,setAttributeNS:_,appendChild:x,insertBefore:k}=Element.prototype;const P=Object.getOwnPropertyDescriptor(HTMLImageElement.prototype,"src");const{set:L,get:E}=P;const C=Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"src");const{set:I,get:S}=C;const z=Object.getOwnPropertyDescriptor(Element.prototype,"innerHTML");const{set:U,get:M}=z;var N=()=>{Element.prototype.setAttribute=w;Element.prototype.setAttributeNS=_;Element.prototype.appendChild=x;Element.prototype.insertBefore=k;Object.defineProperty(HTMLImageElement.prototype,"src",{configurable:!0,enumerable:!0,__proto__:P.__proto__,get:E,set:L});Object.defineProperty(HTMLMediaElement.prototype,"src",{configurable:!0,enumerable:!0,__proto__:C.__proto__,get:S,set:I});Object.defineProperty(Element.prototype,"innerHTML",{configurable:!0,enumerable:!0,__proto__:z.__proto__,get:M,set:U});CSSStyleDeclaration.prototype.__defineSetter__("backgroundImage",(function(e){this.setProperty("background-image",e)}))};var B=()=>{N()};var D=()=>{var e=e=>function(){var t=arguments;if("IMG"===this.tagName&&(!config.skipSrcHookIfNotConnected||this.isConnected)&&("src"===t[0]||"data-src"===t[0])&&t[1]&&0!==t[1].indexOf(config.mLinkBaseUrl)&&0!==t[1].indexOf("data:image")&&(!u(t[1])||d(t[1]))){t[1]=l(t[1]);this.speedsize=!0}else if((!config.skipSrcHookIfNotConnected||this.isConnected)&&"VIDEO"===this.tagName&&("src"===t[0]||"data-src"===t[0])&&!config.ignoreDataAttributes&&t[1]&&0!==t[1].indexOf(config.mLinkBaseUrl)&&(!u(t[1])||d(t[1]))){t[1]=l(t[1]);this.speedsize=!0}var r=e.apply(this,t);return r};Element.prototype.setAttribute=e(w);Element.prototype.setAttributeNS=e(_);var t=e=>function(){var t=arguments;var r=t[0];if(1!==r.nodeType)return e.apply(this,t);if("PICTURE"===r.tagName)R(r);else if("IMG"===r.tagName)g(r);else if("VIDEO"===r.tagName){if(r.isConnected)y(r)}else if(G(r))b(r);var i=e.apply(this,t);return i};Element.prototype.appendChild=t(x);Element.prototype.insertBefore=t(k);Object.defineProperty(HTMLImageElement.prototype,"src",{configurable:!0,enumerable:!0,__proto__:P.__proto__,get:E,set:function(){var e=arguments;if("IMG"===this.tagName&&(!config.skipSrcHookIfNotConnected||this.isConnected)&&e[0]&&0!==e[0].indexOf(config.mLinkBaseUrl)&&0!==e[0].indexOf("data:image")&&(!u(e[0])||d(e[0]))){var t=l(e[0]);e[0]=t}L.apply(this,e)}});Object.defineProperty(HTMLMediaElement.prototype,"src",{configurable:!0,enumerable:!0,__proto__:C.__proto__,get:S,set:function(){var e=arguments;if("VIDEO"===this.tagName&&e[0]&&0!==e[0].indexOf(config.mLinkBaseUrl)&&(!u(e[0])||d(e[0]))){var t=l(e[0]);e[0]=t}I.apply(this,e)}});function r(e){if(!e)return!1;if(0===e.indexOf("http"))return!0;if(0===e.indexOf("/"))return!0;if(0===e.indexOf("."))return!0;if(0===e.indexOf("-"))return!0;if(0===e.indexOf("_"))return!0;if(e.match(/^[A-Z0-9]/i))return!0;return!1}function i(e){var t=e;var i=t.indexOf(" src");for(;i>=0;){var n=t.indexOf("'",i);var a=t.indexOf('"',i);var s;var o='"';if(-1===a&&-1===n)break;if(a>=0&&-1===n){o='"';s=a}else if(n>=0&&-1===a){o="'";s=n}else if(a<n){o='"';s=a}else if(n<a){o="'";s=n}var c=t.indexOf(o,s+1);if(-1===c)break;var g=t.substring(s+1,c);if(i===t.indexOf("srcset")){t=A(t,s+1,c,h(g))}else{var p=!0;if(0===g.indexOf("data:image")||0===g.indexOf(config.mLinkBaseUrl)||!r(g))p=!1;var v=f(g).srcUrl;if(!config.allowCrossOrigin&&u(v)&&!d(v))p=!1;if(p){t=A(t,s+1,c,l(v))}}i=t.indexOf("src",c+1)}return t}CSSStyleDeclaration.prototype.__defineSetter__("backgroundImage",(function(e){var t=e;var r=p(t);for(var i=0;i<r.length;i+=1){var n=r[i];var a=l(f(n).srcUrl);t=t.replace(n,a)}this.setProperty("background-image",t)}));function n(e){var t=e;var r="<img";var n=t.indexOf(r);var a=0;for(;n>=0;){var s=n+r.length;var o=t.indexOf(">",s);var f=t.substring(n,o+1);if(-1===f.indexOf("data-processed")){t=A(t,n,o+1,i(f))}n=t.indexOf(r,o+1);if(++a>50)break}r="<video";var c="</video>";markup=t;a=0;var d=t.indexOf(r);for(;d>=0;){s=d+r.length;o=t.indexOf(c,s)+c.length;var l=t.substring(d,o);if(-1===l.indexOf("data-processed")){t=A(t,d,o,i(l))}d=t.indexOf(r,o+1);if(++a>50)break}return t}Object.defineProperty(Element.prototype,"innerHTML",{configurable:!0,enumerable:!0,__proto__:z.__proto__,get:M,set:function(){var e=arguments;var t=e[0];if(t&&t.indexOf&&(t.indexOf("<img")>=0||t.indexOf("<video")>=0)){var r=n(t);e[0]=r}U.apply(this,e)}})};var H=()=>{D()};if(config.allowedPaths&&config.allowedPaths.length||config.forbiddenPaths&&config.forbiddenPaths.length){var{pushState:T}=window.History.prototype;function j(e){var t=!0;var r=!0;if(config.allowedPaths&&config.allowedPaths.length){r=!1;for(var i=0;i<config.allowedPaths.length;i+=1){if((n=config.allowedPaths[i].toLowerCase())===e){r=!0;break}}if(r)t=!0;else t=!1}if(config.forbiddenPaths&&config.forbiddenPaths.length){r=!0;for(i=0;i<config.forbiddenPaths.length;i+=1){var n;if((n=config.forbiddenPaths[i].toLowerCase()).endsWith("*")&&0===e.indexOf(n.substring(0,n.length-1)))r=!1;else if(n===e){r=!1;break}}if(!r)t=!1}return t}var W=e=>function(){var t=arguments[2]||"";if("string"==typeof t)t=t.toLowerCase();else t="";var r=j(t);if(!r)B();else H();var i=e.apply(this,arguments);return i};window.History.prototype.pushState=W(T);window.addEventListener("popstate",(function(){if(!j(new URL(document.location).pathname.toLowerCase()))B();else H()}))}function R(e){if(e.speedsize||e.hasAttribute("data-processed"))return;e.speedsize=!0;if(e.dataset["speedsize-ignore"]||e.dataset.speedsizeIgnore||e.hasAttribute("data-speedsize-ignore"))return;var t=e.getElementsByTagName("source");var r=e.getElementsByTagName("img")[0];for(var i=0;i<t.length;i+=1){var n=t[i];const e=h(n.srcset);n.srcset=e;const r=n.getAttribute("data-srcset");if(r){const e=h(r);n.setAttribute("data-srcset",e)}}if(r&&r.src&&r.src!==window.location.href){var a=l(r.src);r.removeAttribute("src");r.src=a;if(r.hasAttribute("srcset")){var s=h(r.getAttribute("srcset"));r.setAttribute("srcset",s)}}e.setAttribute("data-processed","true")}function G(e){if(e.style.backgroundImage&&0===e.style.backgroundImage.indexOf('url("'))return!0;if(e.hasAttribute("style")&&e.getAttribute("style").indexOf("background-image")>=0)return!0;if(e.hasAttribute("style")&&e.getAttribute("style").indexOf("background")>=0&&e.getAttribute("style").indexOf("url(")>=0)return!0;return!1}let V=!0;if(config.allowedPaths&&config.allowedPaths.length){var q=!1;for(n=0;n<config.allowedPaths.length;n+=1){if((Z=config.allowedPaths[n].toLowerCase()).endsWith("*")&&0===o.indexOf(Z.substring(0,Z.length-1))||Z===o){q=!0;break}}if(q)V=!0;else V=!1}if(config.forbiddenPaths&&config.forbiddenPaths.length){q=!0;for(n=0;n<config.forbiddenPaths.length;n+=1){var Z;if((Z=config.forbiddenPaths[n].toLowerCase()).endsWith("*")&&0===o.indexOf(Z.substring(0,Z.length-1)))q=!1;else if(Z===o){q=!1;break}}if(!q)V=!1}if(V)D();
})();
</script>
<!-- SpeedSize JS Snippet -->
